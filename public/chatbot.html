<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - Medical Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary-color: #10b981;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --card-background: #ffffff;
            --background: #f8fafc;
            --border-color: #d1d5db;
            --error-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color) 0%, #059669 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 16px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-md);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .header-title p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8fafc;
            padding: 10px 16px;
            border-radius: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .user-details h3 {
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .user-details p {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .logout-btn {
            background: #fef2f2;
            color: var(--error-color);
            border: 1px solid #fecaca;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #fee2e2;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
        }

        .language-selector select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            font-family: 'Inter', sans-serif;
            width: 200px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--shadow-md);
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .chat-card {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .chat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient-primary);
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .chat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .chat-header-text h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .chat-header-text p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .chat-window {
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 20px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 15px 18px;
            border-radius: 18px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .user-message {
            background: var(--gradient-primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background: white;
            border: 1px solid var(--border-color);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .user-avatar-small {
            background: rgba(255, 255, 255, 0.3);
        }

        .ai-avatar-small {
            background: var(--gradient-primary);
            color: white;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-message .message-sender {
            color: rgba(255, 255, 255, 0.9);
        }

        .ai-message .message-sender {
            color: var(--primary-color);
        }

        .message-content {
            line-height: 1.5;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 15px 18px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 18px;
            margin-right: auto;
            max-width: 120px;
            border-bottom-left-radius: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-light);
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        .chat-input-area {
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex-grow: 1;
            padding: 15px 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .action-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-btn.secondary {
            background: #6b7280;
        }

        .action-btn.recording {
            background: var(--error-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .suggestion {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        @media (max-width: 900px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .chat-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .quick-actions {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .chat-input-area {
                flex-wrap: wrap;
            }
            
            .action-btn {
                width: 45px;
                height: 45px;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <button class="back-btn" onclick="window.location.href='index.html'">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </button>
                <div class="header-title">
                    <h1>AI Chatbot</h1>
                    <p>Ask me anything about medical topics</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="userInfo">Dr. Smith</h3>
                        <p>Last login: Today</p>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
            <div class="language-selector">
                <label for="languageSelect">Language:</label>
                <select id="languageSelect">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                </select>
            </div>
        </header>

        <section class="card chat-card">
            <div class="chat-header">
                <div class="chat-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chat-header-text">
                    <h3>AI Medical Assistant Chatbot</h3>
                    <p id="chatbotSubtitle">Your intelligent healthcare companion</p>
                </div>
            </div>

            <div class="chat-controls">
                <div class="control-group">
                    <label class="switch">
                        <input type="checkbox" id="ttsToggle">
                        <span class="slider round"></span>
                    </label>
                    <span class="toggle-label">Text-to-Speech</span>
                    <select id="voiceSelect" style="margin-left: 10px; padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.85rem;">
                        <option value="Joanna">Joanna (Female)</option>
                        <option value="Matthew">Matthew (Male)</option>
                        <option value="Amy">Amy (Female, UK)</option>
                        <option value="Brian">Brian (Male, UK)</option>
                        <option value="Emma">Emma (Female, UK)</option>
                    </select>
                </div>
                <div class="quick-actions">
                    <button class="quick-action-btn" data-question="What are common symptoms of flu?">Flu Symptoms</button>
                    <button class="quick-action-btn" data-question="How to manage high blood pressure?">Blood Pressure</button>
                    <button class="quick-action-btn" data-question="What is a healthy diet?">Healthy Diet</button>
                    <button class="quick-action-btn" data-question="When to see a doctor for a headache?">Headaches</button>
                </div>
            </div>

            <div id="chatWindow" class="chat-window">
                <div class="message ai-message">
                    <div class="message-header">
                        <div class="message-avatar ai-avatar-small">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-sender">Medical Assistant</div>
                    </div>
                    <div class="message-content">
                        Hello! I'm your AI Medical Assistant. I can help answer general health questions, explain medical terms, and provide health information. Remember, I'm not a substitute for professional medical advice. How can I assist you today?
                    </div>
                </div>
            </div>

            <div class="suggestions">
                <div class="suggestion" data-question="What are the symptoms of COVID-19?">COVID-19 Symptoms</div>
                <div class="suggestion" data-question="How can I improve my sleep quality?">Sleep Tips</div>
                <div class="suggestion" data-question="What exercises are good for heart health?">Heart Health</div>
                <div class="suggestion" data-question="How to manage stress and anxiety?">Stress Management</div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="Ask me anything about medical topics..." />
                <button id="micBtn" class="action-btn secondary">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="sendBtn" class="action-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </section>
    </div>

    <script src="auth.js"></script>
    <script>
        const ENDPOINT_QA = "https://lxssie8nzc.execute-api.ap-southeast-2.amazonaws.com/prod/ask";
        const API_BASE_URL = window.location.origin + '/api';
        
        let globalJobId = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const userResult = await getCurrentUser();
                if (userResult.success && userResult.user) {
                    const email = userResult.user.attributes.email || userResult.user.username;
                    const name = userResult.user.attributes.name || email.split('@')[0];
                    document.getElementById('userInfo').textContent = name;
                    
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const dateString = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    document.querySelector('.user-details p').textContent = `Last login: ${dateString}, ${timeString}`;
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('userInfo').textContent = 'User';
            }
            
            const chatInput = document.getElementById("chatInput");
            const sendBtn = document.getElementById("sendBtn");
            const chatWindow = document.getElementById("chatWindow");
            const languageSelect = document.getElementById("languageSelect");
            const ttsToggle = document.getElementById("ttsToggle");
            const voiceSelect = document.getElementById("voiceSelect");
            const micBtn = document.getElementById("micBtn");
            const logoutBtn = document.getElementById("logoutBtn");
            const quickActionBtns = document.querySelectorAll('.quick-action-btn');
            const suggestionBtns = document.querySelectorAll('.suggestion');
            const chatbotSubtitle = document.getElementById("chatbotSubtitle");
            
            let currentLanguage = 'en';
            let isRecording = false;
            let isWaitingForResponse = false;
            let ws = null;
            let activeSessionId = null;
            let audioContext = null;
            let mediaStream = null;
            let sourceNode = null;
            let processorNode = null;

            const savedJobId = sessionStorage.getItem('globalJobId');
            if (savedJobId) {
                globalJobId = savedJobId;
                chatbotSubtitle.textContent = "Document uploaded - Ask questions about your document";
                addChat("Assistant", "I can answer questions about your uploaded document. What would you like to know?");
            } else {
                chatbotSubtitle.textContent = "Upload a document from the dashboard to ask questions about it";
            }

            logoutBtn.addEventListener('click', function() {
                logout();
            });

            sendBtn.addEventListener("click", sendMessage);
            chatInput.addEventListener("keypress", e => { 
                if (e.key === "Enter") sendMessage(); 
            });
            languageSelect.addEventListener("change", (e) => { 
                currentLanguage = e.target.value; 
            });
            micBtn.addEventListener("click", toggleRecording);

            quickActionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const question = this.getAttribute('data-question');
                    chatInput.value = question;
                    sendMessage();
                });
            });

            suggestionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const question = this.getAttribute('data-question');
                    chatInput.value = question;
                    sendMessage();
                });
            });

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message || isWaitingForResponse) return;

                addChat("You", message);
                chatInput.value = "";
                isWaitingForResponse = true;
                
                showTypingIndicator();
                
                try {
                    let response;
                    
                    const currentJobId = globalJobId || sessionStorage.getItem('globalJobId');
                    if (currentJobId) {
                        globalJobId = currentJobId;
                        response = await askQuestionAboutDocument(message);
                    } else {
                        response = generateAIResponse(message);
                    }
                    
                    removeTypingIndicator();
                    
                    addChat("Assistant", response);
                    
                    if (ttsToggle.checked) {
                        await speakText(response);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    removeTypingIndicator();
                    addChat("Assistant", "⚠️ I'm sorry, I encountered an error. Please try again.");
                } finally {
                    isWaitingForResponse = false;
                }
            }
            
            async function askQuestionAboutDocument(question) {
                try {
                    const currentJobId = globalJobId || sessionStorage.getItem('globalJobId');
                    if (!currentJobId) {
                        return "Please upload a document from the dashboard first to ask questions about it.";
                    }
                    
                    let questionToAsk = question;
                    if (currentLanguage !== 'en') {
                        const translationResponse = await authenticatedFetch(`${API_BASE_URL}/translate`, {
                            method: 'POST',
                            body: JSON.stringify({ text: question, targetLanguage: 'en' })
                        });
                        const translationData = await translationResponse.json();
                        questionToAsk = translationData.translatedText;
                    }

                    const res = await fetch(ENDPOINT_QA, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ job_id: currentJobId, question: questionToAsk })
                    });

                    const js = await res.json();
                    let answer = js.answer || js.result || JSON.stringify(js);

                    if (currentLanguage !== 'en') {
                        const translationResponse = await authenticatedFetch(`${API_BASE_URL}/translate`, {
                            method: 'POST',
                            body: JSON.stringify({ text: answer, targetLanguage: currentLanguage })
                        });
                        const translationData = await translationResponse.json();
                        answer = translationData.translatedText;
                    }
                    
                    return answer;
                } catch (error) {
                    console.error('Q&A error:', error);
                    return "I'm sorry, I couldn't process your question. Please try again.";
                }
            }
            
            async function authenticatedFetch(url, options = {}) {
                const token = localStorage.getItem('accessToken');
                if (!token) throw new Error('Not authenticated');
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                };
                
                return fetch(url, { ...options, headers });
            }

            function generateAIResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                    return "Hello! I'm here to help with medical questions. What would you like to know?";
                } else if (lowerMessage.includes('symptom') && lowerMessage.includes('covid')) {
                    return "Common COVID-19 symptoms include fever, cough, fatigue, loss of taste or smell, and difficulty breathing. However, symptoms can vary widely. If you're experiencing severe symptoms like difficulty breathing, persistent chest pain, or confusion, seek medical attention immediately.";
                } else if (lowerMessage.includes('symptom')) {
                    return "I can help you understand symptoms, but remember: I'm not a substitute for professional medical advice. If you're experiencing concerning symptoms, please consult with a healthcare provider for proper diagnosis and treatment.";
                } else if (lowerMessage.includes('blood pressure') || lowerMessage.includes('hypertension')) {
                    return "Managing high blood pressure typically involves lifestyle changes like reducing salt intake, regular exercise, maintaining a healthy weight, and limiting alcohol. Medications may also be prescribed by your doctor. Regular monitoring is important.";
                } else if (lowerMessage.includes('treatment') || lowerMessage.includes('medicine')) {
                    return "For treatment and medication information, it's important to consult with a licensed healthcare provider who can assess your specific situation, medical history, and provide personalized recommendations.";
                } else if (lowerMessage.includes('diet') || lowerMessage.includes('nutrition')) {
                    return "A balanced diet includes fruits, vegetables, whole grains, lean proteins, and healthy fats. The Mediterranean diet is often recommended for heart health. Limit processed foods, sugar, and saturated fats. Consult a nutritionist for personalized advice.";
                } else if (lowerMessage.includes('exercise') || lowerMessage.includes('fitness')) {
                    return "Regular exercise is important for overall health. Aim for at least 150 minutes of moderate aerobic activity or 75 minutes of vigorous activity weekly, plus strength training twice a week. Always consult your doctor before starting a new exercise program.";
                } else if (lowerMessage.includes('sleep')) {
                    return "Good sleep hygiene includes maintaining a consistent sleep schedule, creating a restful environment, avoiding caffeine and screens before bedtime, and managing stress. Most adults need 7-9 hours of sleep per night.";
                } else if (lowerMessage.includes('stress') || lowerMessage.includes('anxiety')) {
                    return "Managing stress can include techniques like deep breathing, meditation, regular exercise, adequate sleep, and talking to a therapist. If you're experiencing severe anxiety or depression, please seek professional help.";
                } else if (lowerMessage.includes('emergency')) {
                    return "If this is a medical emergency, please call emergency services immediately (911 or your local emergency number). Do not delay seeking professional medical help for serious symptoms.";
                } else {
                    return "Thank you for your question. I'm an AI assistant designed to provide general medical information. For specific medical advice, diagnosis, or treatment, please consult with a qualified healthcare professional. How else can I assist you?";
                }
            }

            function addChat(sender, msg) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message");
                messageDiv.classList.add(sender === "You" ? "user-message" : "ai-message");
                
                const avatarClass = sender === "You" ? "user-avatar-small" : "ai-avatar-small";
                const avatarIcon = sender === "You" ? "fas fa-user" : "fas fa-robot";
                const displayName = sender === "You" ? "You" : "Medical Assistant";
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar ${avatarClass}">
                            <i class="${avatarIcon}"></i>
                        </div>
                        <div class="message-sender">${displayName}</div>
                    </div>
                    <div class="message-content">${msg}</div>
                `;
                
                chatWindow.appendChild(messageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function showTypingIndicator() {
                const typingDiv = document.createElement("div");
                typingDiv.classList.add("typing-indicator");
                typingDiv.id = "typingIndicator";
                typingDiv.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                chatWindow.appendChild(typingDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function removeTypingIndicator() {
                const typingIndicator = document.getElementById("typingIndicator");
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            async function speakText(text) {
                if (!ttsToggle.checked) return;
                
                try {
                    const selectedVoice = voiceSelect.value || 'Joanna';
                    const response = await authenticatedFetch(`${API_BASE_URL}/tts`, {
                        method: 'POST',
                        body: JSON.stringify({
                            text,
                            language: currentLanguage,
                            voice: selectedVoice
                        })
                    });
                    const data = await response.json();
                    const audio = new Audio(`data:audio/mp3;base64,${data.audio}`);
                    await audio.play();
                } catch (error) {
                    console.error('TTS error:', error);
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.rate = 0.9;
                        utterance.pitch = 1;
                        utterance.volume = 0.8;
                        window.speechSynthesis.speak(utterance);
                    }
                }
            }

            async function openWebSocket() {
                return new Promise((resolve, reject) => {
                    const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
                    const wsUrl = `${proto}://${window.location.host}/stt`;
                    ws = new WebSocket(wsUrl);

                    ws.onopen = () => {
                        console.log('WebSocket connected');
                        ws.send(JSON.stringify({ type: 'lang', language: currentLanguage }));
                        resolve();
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        reject(error);
                    };

                    ws.onclose = () => {
                        console.log('WebSocket closed');
                    };

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('WebSocket message received:', data);
                            if (data.type === 'session') {
                                activeSessionId = data.sessionId;
                                console.log('Session ID:', activeSessionId);
                            } else if (data.type === 'transcript') {
                                console.log('Transcript received:', data.text, 'isPartial:', data.isPartial);
                                chatInput.value = data.text;
                            }
                        } catch (err) {
                            console.error('Error parsing WebSocket message:', err);
                        }
                    };
                });
            }

            function closeWebSocket() {
                if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                    console.log('Closing WebSocket...');
                    ws.close(1000, 'Session ended');
                    ws = null;
                }
            }

            function floatTo16BitPCM(input) {
                const l = input.length;
                const result = new Int16Array(l);
                for (let i = 0; i < l; i++) {
                    let s = Math.max(-1, Math.min(1, input[i]));
                    result[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                }
                return result;
            }

            function downsampleAndConvertTo16BitPCM(buffer, fromSampleRate, toSampleRate) {
                if (!buffer || buffer.length === 0) return new Int16Array(0);
                if (toSampleRate === fromSampleRate) return floatTo16BitPCM(buffer);
                const sampleRateRatio = fromSampleRate / toSampleRate;
                const newLength = Math.round(buffer.length / sampleRateRatio);
                const result = new Int16Array(newLength);
                let offsetResult = 0, offsetBuffer = 0;
                while (offsetResult < result.length) {
                    const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                    let accum = 0, count = 0;
                    for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                        accum += buffer[i]; count++;
                    }
                    const v = count ? accum / count : 0;
                    let s = Math.max(-1, Math.min(1, v));
                    result[offsetResult] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    offsetResult++; offsetBuffer = nextOffsetBuffer;
                }
                return result;
            }

            async function toggleRecording() {
                if (!isRecording) {
                    try {
                        await openWebSocket();
                        const stream = await navigator.mediaDevices.getUserMedia({
                            audio: { channelCount: 1, sampleRate: 16000, echoCancellation: true, noiseSuppression: true }
                        });

                        // Try to create AudioContext with 16kHz, but browser may use different rate
                        // We'll use the actual sampleRate and downsample to 16kHz
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                        console.log(`AudioContext created with sampleRate: ${audioContext.sampleRate} Hz (will downsample to 16000 Hz)`);
                        mediaStream = stream;
                        sourceNode = audioContext.createMediaStreamSource(stream);
                        processorNode = audioContext.createScriptProcessor(4096, 1, 1);
                        sourceNode.connect(processorNode);
                        processorNode.connect(audioContext.destination);

                        processorNode.onaudioprocess = (e) => {
                            if (!isRecording || !ws || ws.readyState !== WebSocket.OPEN) return;
                            const inputData = e.inputBuffer.getChannelData(0);
                            // Always downsample to 16kHz (browser-supported frequency)
                            // Use actual audioContext sampleRate (may be 48kHz even if we requested 16kHz)
                            const actualSampleRate = audioContext.sampleRate;
                            const pcmData = downsampleAndConvertTo16BitPCM(inputData, actualSampleRate, 16000);
                            ws.send(pcmData.buffer);
                        };

                        isRecording = true;
                        micBtn.classList.add('recording');
                        chatInput.placeholder = "Listening... Speak now";

                    } catch (error) {
                        console.error('Error starting recording:', error);
                        addChat("Assistant", "⚠️ Microphone access denied or WebSocket error. Please check your permissions.");
                        closeWebSocket();
                    }
                } else {
                    isRecording = false;
                    micBtn.classList.remove('recording');
                    chatInput.placeholder = "Ask me anything about medical topics...";

                    if (processorNode) processorNode.disconnect();
                    if (sourceNode) sourceNode.disconnect();
                    if (audioContext) await audioContext.close().catch(() => {});
                    if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());

                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'stop' }));
                    }

                    closeWebSocket();
                }
            }
        });
    </script>
</body>
</html>